<app-loading *ngIf="loading"></app-loading>
<div *ngIf="!loading" class="wrapper bg-white rounded shadow">
  <app-scroll-to-top></app-scroll-to-top>
  <div class="app-title m-bottom-25">
    <h2>{{ isCreate ? "Thêm mới" : "Cập nhật" }} thức ăn</h2>
  </div>

  <div class="content">
    <form [formGroup]="form" (ngSubmit)="onSubmit()">
      <mat-form-field
        appearance="outline"
        style="width: 100%"
        floatLabel="always"
      >
        <mat-label>Tên thức ăn <span class="color-red">(*)</span></mat-label>
        <input
          type="text"
          matInput
          maxlength="100"
          formControlName="name"
        />

        <mat-error *ngIf="f.name.errors?.required"
          >Tên thức ăn không được trống.</mat-error
        >
        <mat-error *ngIf="f.name.errors?.inValid"
          >Tên thức ăn không hợp lệ.</mat-error
        >
        <mat-error *ngIf="f.name.errors?.minlength"
          >Tên thức ăn phải có ít nhất 5 ký tự.</mat-error
        >
      </mat-form-field>

      <mat-form-field
        appearance="outline"
        style="width: 100%"
        floatLabel="always"
      >
        <mat-label>Đơn vị đo <span class="color-red">(*)</span></mat-label>
        <input
          type="text"
          matInput
          maxlength="100"
          formControlName="unit"
        />

        <mat-error *ngIf="f.unit.errors?.required"
          >Đơn vị đo không được trống.</mat-error
        >
      </mat-form-field>

      <mat-form-field
        appearance="outline"
        style="width: 100%"
        floatLabel="always"
      >
        <mat-label>Khu vực <span class="color-red">(*)</span></mat-label>
        <mat-select formControlName="idArea">
          <mat-option>--</mat-option>
          <mat-option *ngFor="let area of areas" [value]="area._id">
            {{ area.name }}
          </mat-option>
        </mat-select>

        <mat-error *ngIf="f.idArea.errors?.required"
          >Vui lòng chọn khu vực.</mat-error
        >
      </mat-form-field>

      <div class="ingredient-list" formArrayName="ingredient">
        <div
          class="ingredient-list-item"
          *ngFor="let _ingredient of ingredient.controls; index as i"
        >
          <ng-container [formGroupName]="i">
            <input type="hidden" formControlName="idIngredient" />
            <div class="d-flex align-items-center justify-content-between ingredient-list-item-header">
              <h4>Thành phần thứ {{ i + 1 }}</h4>
              <app-button-icon
                [customClasses]="['color-red']"
                matTooltip="Xoá"
                (click)="removeIngredient(i, _ingredient.value, $event)"
                [iconName]="'highlight_off'"
              ></app-button-icon>
            </div>

            <div class="d-flex justify-content-center">
              <mat-form-field
                appearance="outline"
                style="width: 90%"
                floatLabel="always"
              >
                <mat-label
                  >Tên thành phần <span class="color-red">(*)</span></mat-label
                >
                <input
                  type="text"
                  matInput
                  formControlName="name"
                  maxlength="100"
                />

                <mat-error
                  *ngIf="
                    ingredient.controls[i].get('name')?.hasError('required')
                  "
                  >Tên thành phần không được trống.</mat-error
                >
                <mat-error
                  *ngIf="
                    ingredient.controls[i].get('name')?.hasError('inValid')
                  "
                  >Tên thành phần không hợp lệ.</mat-error
                >
                <mat-error
                  *ngIf="
                    ingredient.controls[i].get('name')?.hasError('minlength')
                  "
                  >Tên giai đoạn ít nhất 5 ký tự.</mat-error
                >
              </mat-form-field>
            </div>

            <div class="d-flex justify-content-center">
              <mat-form-field
                appearance="outline"
                style="width: 90%"
                floatLabel="always"
              >
                <mat-label
                  >Hàm lượng <span class="color-red">(*)</span></mat-label
                >
                <input type="number" matInput formControlName="amount" />

                <mat-hint>Đơn vị: (%)</mat-hint>
                <mat-error
                  *ngIf="
                    ingredient.controls[i].get('amount')?.hasError('required')
                  "
                  >Hàm lượng không được trống.</mat-error
                >
              </mat-form-field>
            </div>
          </ng-container>
        </div>

        <app-button
          [customClasses]="['app-button-green']"
          [buttonType]="'button'"
          [buttonContent]="'Thêm thành phần'"
          (click)="addIngredient($event)"
        ></app-button>
      </div>

      <mat-divider></mat-divider>
      <div class="button-group">
        <app-button
          [customClasses]="['app-button-brown']"
          [buttonType]="'submit'"
          [buttonContent]="!!isCreate ? 'Tạo mới' : 'Cập nhật'"
          [disabledCondition]="
            ingredientToRemove.length > 0
              ? false
              : !form.valid || !form.dirty || submitted
          "
          [showSpinner]="submitted"
        ></app-button>

        <app-button
          [customClasses]="['app-button-grey']"
          [buttonType]="'button'"
          [buttonContent]="'Huỷ bỏ'"
          (click)="onReset()"
        ></app-button>
      </div>
    </form>
  </div>
</div>
